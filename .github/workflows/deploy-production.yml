name: Deploy Production

on:
  push:
    branches: ["main"]

jobs:
  #/////////////////////
  # 👾 GIT METADATA 👾 #
  #////////////////////

  git-meta:
    name: git metadata
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Git Metadata
        id: git-meta
        run: |
          github_commit_sha="${{ github.event.before }}" | cut -c1-8 >> $GITHUB_OUTPUT       
          github_commit_author_login=${{ github.actor }}
          github_deployment=1
          github_org=${{ github.repository_owner }}
          github_repo=${{ github.repository }}
          github_commit_org=${{ github.repository_owner }}
          github_commit_repo=${{ github.repository }}
          github_commit_message=$(git show -s --format=%s $github_commit_sha)
          github_commit_ref=${{ github.head_ref }}

          vercel_git_metadata="-m githubCommitSha=$github_commit_sha -m githubCommitAuthorName=$github_commit_author_login -m githubCommitAuthorLogin=$github_commit_author_login -m githubDeployment=$github_deployment -m githubOrg=$github_org -m githubRepo=$github_repo -m githubCommitOrg=$github_commit_org -m githubCommitRepo=$github_commit_repo -m githubCommitMessage=\"$github_commit_message\" -m githubCommitRef=$github_commit_ref"                 

          echo "github_commit_sha=$github_commit_sha" >> $GITHUB_OUTPUT
          echo "github_commit_author_name=$github_commit_author_name" >> $GITHUB_OUTPUT
          echo "github_commit_author_login=$github_commit_author_login" >> $GITHUB_OUTPUT
          echo "github_deployment=$github_deployment" >> $GITHUB_OUTPUT
          echo "github_org=$github_org" >> $GITHUB_OUTPUT
          echo "github_repo=$github_repo" >> $GITHUB_OUTPUT
          echo "github_commit_org=$github_commit_org" >> $GITHUB_OUTPUT
          echo "github_commit_repo=$github_commit_repo" >> $GITHUB_OUTPUT
          echo "github_commit_message=$github_commit_message" >> $GITHUB_OUTPUT
          echo "github_commit_ref=$github_commit_ref" >> $GITHUB_OUTPUT
          echo "vercel_git_metadata=$vercel_git_metadata" >> $GITHUB_OUTPUT

    outputs:
      git_branch_name: ${{ steps.git-meta.outputs.github_commit_ref }}
      github_commit_sha: ${{ steps.git-meta.outputs.github_commit_sha }}
      github_commit_author_name: ${{ steps.git-meta.outputs.github_commit_author_name }}
      github_commit_author_login: ${{ steps.git-meta.outputs.github_commit_author_login }}
      github_deployment: ${{ steps.git-meta.outputs.github_deployment }}
      github_org: ${{ steps.git-meta.outputs.github_org }}
      github_repo: ${{ steps.git-meta.outputs.github_repo }}
      github_commit_org: ${{ steps.git-meta.outputs.github_commit_org }}
      github_commit_repo: ${{ steps.git-meta.outputs.github_commit_repo }}
      github_commit_message: ${{ steps.git-meta.outputs.github_commit_message }}
      github_commit_ref: ${{ steps.git-meta.outputs.github_commit_ref }}
      vercel_git_metadata: ${{ steps.git-meta.outputs.vercel_git_metadata }}

  #/////////////////////
  # 🐘 NEON DB:PUSH 🐘 #
  #////////////////////

  db-push:
    name: db:push
    needs: [git-meta]
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup node/pnpm/turbo
        uses: ./tooling/github/setup

      - name: Install the Neon CLI
        run: pnpm install -g neonctl

      - name: Copy env
        shell: bash
        run: cp .env.example .env

      - name: Get Neon Branch ID
        id: get-neon-branch
        run: |
          echo branch_id=$(neonctl branches get ${{ needs.git-meta.outputs.git_branch_name }} --project-id ${{ secrets.NEON_PROJECT_ID }} --api-key ${{ secrets.NEON_API_KEY }} --output json | jq -r '.id') >> $GITHUB_OUTPUT

      - name: db:push
        id: db-push
        run: |
          rm -f .env
          touch .env

          echo DATABASE_URL=$(neonctl cs ${{ secrets.NEON_MAIN_BRANCH_NAME }} --project-id ${{ secrets.NEON_PROJECT_ID }} --role-name ${{ secrets.PG_USERNAME }} --database-name ${{ secrets.PG_DATABASE }} --api-key ${{ secrets.NEON_API_KEY }}) >> .env
          echo DIRECT_DATABASE_URL=$(neonctl cs ${{ secrets.NEON_MAIN_BRANCH_NAME }} --project-id ${{ secrets.NEON_PROJECT_ID }} --role-name ${{ secrets.PG_USERNAME }} --database-name ${{ secrets.PG_DATABASE }} --api-key ${{ secrets.NEON_API_KEY }}) >> .env

          pnpm db:push

    outputs:
      neon_branch_id: ${{ steps.get-neon-branch.outputs.branch_id }}

  #////////////////////////////////////////////////////////////
  # 📱 DEPLOY APP -- PROD (Not Aliasing to Production Yet) 📱 #
  #///////////////////////////////////////////////////////////

  deploy-app:
    name: vercel prod - app.barely.io
    needs: [db-push, git-meta]
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      TURBO_TEAM: ${{ secrets.VERCEL_TEAM_ID }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_TEAM_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_APP_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup node/pnpm/turbo
        uses: ./tooling/github/setup

      - name: Install Vercel CLI
        run: |
          pnpm i -g vercel@latest
          vercel link --repo --scope=barelylabs --yes --token=${{ secrets.VERCEL_TOKEN }}
          vercel link --cwd apps/app --scope=barelylabs --yes --token=${{ secrets.VERCEL_TOKEN }}

      - name: Pull Vercel -- app
        run: |
          vercel pull --cwd apps/app --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

          VERCEL_URL=app.barely.io
          sed -i '/VERCEL_URL/d' ./apps/app/.vercel/.env.production.local
          echo "VERCEL_URL=$VERCEL_URL" >> ./apps/app/.vercel/.env.production.local
          cp ./apps/link/.vercel/.env.production.local .env

      - name: Build Project Artifacts -- app
        run: turbo build:vercel --filter=@barely/app --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel -- app
        id: deploy
        run: |
          vercel deploy --cwd apps/app --prebuilt --prod --skip-domain ${{ needs.git-meta.outputs.vercel_git_metadata }} --token=${{ secrets.VERCEL_TOKEN }}
          inspect=$(vercel inspect $https://app.barely.io --token=${{ secrets.VERCEL_TOKEN }} 2>&1)
          deployment_id=$(echo "$inspect" | grep -m 1 '^    id' | awk '{print $NF}' | cut -d'_' -f 2-)
          inspect_url="https://vercel.com/barelylabs/app/$deployment_id"
          echo "inspect_url=$inspect_url" >> $GITHUB_OUTPUT

    outputs:
      deployment_id: ${{ steps.deploy.outputs.deployment_id }}
      inspect_url: ${{ steps.deploy.outputs.inspect_url }}

  #/////////////////////////////////////////////////////////////
  # 🔗 DEPLOY LINK --PROD  (Not Aliasing to Production Yet) 🔗 #
  #////////////////////////////////////////////////////////////

  deploy-link:
    name: vercel prod - link.barely.io
    needs: [db-push, git-meta]
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      TURBO_TEAM: ${{ secrets.VERCEL_TEAM_ID }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_TEAM_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_LINK_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup node/pnpm/turbo
        uses: ./tooling/github/setup

      - name: Install Vercel CLI
        run: |
          pnpm i -g vercel@latest
          vercel link --repo --scope=barelylabs --yes --token=${{ secrets.VERCEL_TOKEN }}
          vercel link --cwd apps/link --scope=barelylabs --yes --token=${{ secrets.VERCEL_TOKEN }}

      - name: Pull Vercel -- link
        run: |
          vercel pull --cwd apps/link --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

          VERCEL_URL=barely.link
          sed -i '/VERCEL_URL/d' ./apps/link/.vercel/.env.production.local
          echo "VERCEL_URL=$VERCEL_URL" >> ./apps/link/.vercel/.env.production.local
          cp ./apps/link/.vercel/.env.production.local .env

      - name: Build Project Artifacts -- link
        run: turbo build:vercel --filter=@barely/link --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel -- link
        id: deploy
        run: |
          vercel deploy --cwd apps/link --prebuilt --prod --skip-domain ${{ needs.git-meta.outputs.vercel_git_metadata }} --token=${{ secrets.VERCEL_TOKEN }}
          inspect=$(vercel inspect $https://link.barely.io --token=${{ secrets.VERCEL_TOKEN }} 2>&1)
          deployment_id=$(echo "$inspect" | grep -m 1 '^    id' | awk '{print $NF}' | cut -d'_' -f 2-)
          inspect_url="https://vercel.com/barelylabs/link/$deployment_id"
          echo "inspect_url=$inspect_url" >> $GITHUB_OUTPUT

    outputs:
      deployment_id: ${{ steps.deploy.outputs.deployment_id }}
      inspect_url: ${{ steps.deploy.outputs.inspect_url }}

  #//////////////////////////////////////////
  # 🚀 PROMOTE APPS TO PRODUCTION DOMAINS 🚀 #
  #//////////////////////////////////////////

  promote-app:
    name: Promote app to production
    needs: [deploy-app, deploy-link]
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_TEAM_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_APP_PROJECT_ID }}
    steps:
      - name: Install Vercel CLI
        run: npm i -g vercel@latest

      - name: Promote app to production
        run: vercel promote ${{ needs.deploy-app.outputs.deployment_id }} --token=${{ secrets.VERCEL_TOKEN }}

  promote-link:
    name: Promote link to production
    needs: [deploy-app, deploy-link]
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_TEAM_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_LINK_PROJECT_ID }}
    steps:
      - name: Install Vercel CLI
        run: npm i -g vercel@latest

      - name: Promote link to production
        run: vercel promote ${{ needs.deploy-link.outputs.deployment_id }} --token=${{ secrets.VERCEL_TOKEN }}

  #///////////////////////////////////////////////
  # 🚨 ROLLBACK APPS (IF ANY PROMOTION FAILS) 🚨 #
  #//////////////////////////////////////////////

  # ref: https://dev.to/philw_/using-vercels-instant-rollback-feature-in-your-own-cicd-pipeline-57oi

  rollback-app:
    name: Rollback app if any deployments fail
    needs: [promote-app, promote-link]
    if: ${{ failure() }}
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_TEAM_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_APP_PROJECT_ID }}
    steps:
      - name: Install Vercel CLI
        run: npm i -g vercel@latest

      - name: Rollback app
        run: |
          ROLLBACK_DEPLOYMENT_ID=$(curl -s "https://api.vercel.com/v6/deployments?teamId=${{ secrets.VERCEL_TEAM_ID }}&projectId=${{ secrets.VERCEL_APP_PROJECT_ID}}&limit=2&rollbackCandidate=true&state=READY&target=production" -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" | jq -r '.deployments[1].uid')
          echo "Rolling back to the previous deployment ID: $ROLLBACK_DEPLOYMENT_ID"
          vercel rollback $ROLLBACK_DEPLOYMENT_ID --scope=barelylabs --token=${{ secrets.VERCEL_TOKEN }}

  rollback-link:
    name: Rollback link if any deployments fail
    needs: [promote-app, promote-link]
    if: ${{ failure() }}
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_TEAM_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_LINK_PROJECT_ID }}
    steps:
      - name: Install Vercel CLI
        run: npm i -g vercel@latest

      - name: Rollback link
        run: |
          ROLLBACK_DEPLOYMENT_ID=$(curl -s "https://api.vercel.com/v6/deployments?teamId=${{ secrets.VERCEL_TEAM_ID }}&projectId=${{ secrets.VERCEL_LINK_PROJECT_ID}}&limit=2&rollbackCandidate=true&state=READY&target=production" -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" | jq -r '.deployments[1].uid')
          echo "Rolling back to the previous deployment ID: $ROLLBACK_DEPLOYMENT_ID"
          vercel rollback $ROLLBACK_DEPLOYMENT_ID --scope=barelylabs --token=${{ secrets.VERCEL_TOKEN }}

  #/////////////#
  # 🧹 CLEAN UP #
  #/////////////#

  delete-neon-branch:
    needs: [db-push, promote-app, promote-link]
    runs-on: ubuntu-latest
    steps:
      - name: Delete Neon Branch
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ secrets.NEON_PROJECT_ID }}
          branch: ${{ needs.db-push.outputs.neon_branch_id }}
          api_key: ${{ secrets.NEON_API_KEY }}
