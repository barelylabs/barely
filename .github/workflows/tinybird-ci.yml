name: Tinybird CI/CD

on:
  pull_request:
    paths:
      - 'packages/tb/tinybird/**'
      - '!packages/tb/tinybird/**.md'
      - '.github/workflows/tinybird-ci.yml'
  push:
    branches:
      - main
    paths:
      - 'packages/tb/tinybird/**'
      - '!packages/tb/tinybird/**.md'
      - '.github/workflows/tinybird-ci.yml'
  merge_group:
    types: [checks_requested]

jobs:
  validate:
    name: Validate Tinybird Resources in Branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-tinybird-cli
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Tinybird CLI
        run: |
          pip install tinybird-cli
          tb --version

      - name: Create or Use CI Branch
        if: github.event_name == 'pull_request'
        env:
          TB_TOKEN: ${{ secrets.TINYBIRD_API_KEY }}
          TB_HOST: https://api.us-east.tinybird.co
        run: |
          cd packages/tb/tinybird
          BRANCH_NAME="ci_pr_${{ github.event.pull_request.number }}"

          # Establish workspace context first
          echo "Setting workspace context to 'barely'..."
          tb workspace use barely

          # Try to use existing branch, create if it doesn't exist
          if ! tb branch use $BRANCH_NAME 2>/dev/null; then
            echo "Creating new branch: $BRANCH_NAME"
            tb branch create $BRANCH_NAME
            tb branch use $BRANCH_NAME
          else
            echo "Using existing branch: $BRANCH_NAME"
          fi

      - name: Push Changes to Branch
        if: github.event_name == 'pull_request'
        env:
          TB_TOKEN: ${{ secrets.TINYBIRD_API_KEY }}
          TB_HOST: https://api.us-east.tinybird.co
        run: |
          cd packages/tb/tinybird
          # Ensure workspace context is set
          tb workspace use barely
          
          echo "Pushing changes to CI branch..."
          tb push --force --yes

          # Run diff to show what changed
          echo "\nChanges applied:"
          tb diff

      - name: Validate Main Branch (Push to main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          TB_TOKEN: ${{ secrets.TINYBIRD_API_KEY }}
          TB_HOST: https://api.us-east.tinybird.co
        run: |
          cd packages/tb/tinybird
          # Ensure workspace context is set
          echo "Setting workspace context to 'barely'..."
          tb workspace use barely
          
          echo "Validating changes for main workspace..."
          tb push --dry-run --yes

  deploy:
    name: Deploy to Main Workspace
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Tinybird CLI
        run: |
          pip install tinybird-cli
          tb --version

      - name: Deploy to Main Workspace
        env:
          TB_TOKEN: ${{ secrets.TINYBIRD_API_KEY }}
          TB_HOST: https://api.us-east.tinybird.co
        run: |
          cd packages/tb/tinybird
          # Establish workspace context first
          echo "Setting workspace context to 'barely'..."
          tb workspace use barely
          
          echo "Ensuring we're on main branch..."
          tb branch use main

          echo "Deploying changes to main workspace..."
          tb push --force --yes

      - name: Verify Deployment
        env:
          TB_TOKEN: ${{ secrets.TINYBIRD_API_KEY }}
          TB_HOST: https://api.us-east.tinybird.co
        run: |
          cd packages/tb/tinybird
          # Ensure workspace context is set
          tb workspace use barely
          
          echo "Verifying deployment..."
          tb workspace current

          # Show recent changes
          echo "\nRecent changes:"
          tb diff

  cleanup:
    name: Cleanup CI Branches
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.action == 'closed' || github.event.action == 'merged')
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Tinybird CLI
        run: |
          pip install tinybird-cli

      - name: Remove CI Branch
        env:
          TB_TOKEN: ${{ secrets.TINYBIRD_API_KEY }}
          TB_HOST: https://api.us-east.tinybird.co
        run: |
          # Establish workspace context first
          tb workspace use barely
          
          BRANCH_NAME="ci_pr_${{ github.event.pull_request.number }}"
          echo "Removing CI branch: $BRANCH_NAME"
          tb branch rm $BRANCH_NAME --yes || echo "Branch already removed or doesn't exist"
